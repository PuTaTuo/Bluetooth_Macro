<!doctype html>
<meta charset="utf-8">
<title>ESP32 MacroPad — Web Flasher</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;margin:24px;background:#fafafa;color:#222}
  h1{margin:0 0 12px}
  .card{background:#fff;border:1px solid #ddd;border-radius:12px;padding:16px;max-width:900px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  label{font-size:14px;color:#444}
  select{padding:6px 8px;border:1px solid #ccc;border-radius:8px}
  button{padding:10px 14px;border:1px solid #1a73e8;background:#1a73e8;color:#fff;border-radius:10px;cursor:pointer}
  button.secondary{background:#fff;color:#1a73e8}
  .muted{color:#666;font-size:13px}
  #log{white-space:pre-wrap;background:#111;color:#eee;border-radius:10px;padding:12px;height:260px;overflow:auto;
       font-family:ui-monospace,Consolas,monospace;font-size:12px}
  .ok{color:#0a7}.warn{color:#c60}.err{color:#d33}
</style>

<h1>ESP32 MacroPad — One-Click Web Flasher</h1>
<p class="muted">1) Connect → select serial port (Chrome/Edge). 2) Flash. If issues: use 115200, shorter cable, hold <b>BOOT</b>, or tick <b>Erase first</b>.</p>

<div class="card">
  <div class="row" style="margin-bottom:12px">
    <button id="connect">Connect</button>
    <label>Baud
      <select id="baud">
        <option>115200</option><option>230400</option><option>460800</option><option>921600</option>
      </select>
    </label>
    <label>Flash mode
      <select id="mode"><option value="dio">dio</option><option value="qio">qio</option><option value="dout">dout</option><option value="qout">qout</option></select>
    </label>
    <label>Flash freq
      <select id="freq"><option value="40m">40m</option><option value="80m">80m</option></select>
    </label>
    <label><input type="checkbox" id="erase"> Erase first</label>
  </div>

  <div class="row" style="margin-bottom:12px">
    <button class="secondary" id="test">Test download</button>
    <button id="flash">Flash</button>
    <span id="status" class="muted"></span>
  </div>

  <div id="log"></div>
</div>

<!-- ① 先加载本地 bundle：务必与本文件同目录 -->
<script src="./esptool-bundle.js"></script>

<!-- ② 再写逻辑：此时全局已有 Transport / ESPLoader -->
<!-- 放在 body 底部；确保整页通过 HTTPS 打开（GitHub Pages 默认是 https） -->
<script type="module">
  import { ESPLoader, Transport } from "https://unpkg.com/esptool-js@0.5.6/lib/index.js";

  // 简单终端适配：把信息写到页面上的 <pre id="log">
  const term = {
    clean() { document.getElementById("log").textContent = ""; },
    writeLine(d) { document.getElementById("log").textContent += d + "\n"; },
    write(d) { document.getElementById("log").textContent += d; }
  };

  // 这些 URL 换成你仓库里的三个 bin（已经是 raw 链接则更好）
  const BIN_BOOT  = "https://raw.githubusercontent.com/PuTaTuo/Bluetooth_Macro/main/bootloader.bin";
  const BIN_PART  = "https://raw.githubusercontent.com/PuTaTuo/Bluetooth_Macro/main/partition.bin";
  const BIN_APP   = "https://raw.githubusercontent.com/PuTaTuo/Bluetooth_Macro/main/firmware.bin";

  // 固定写入地址（ESP32 经典芯片）
  const ADDR_BOOT = 0x1000;
  const ADDR_PART = 0x8000;
  const ADDR_APP  = 0x10000;

  // 简单工具函数：拉取二进制并转成 Uint8Array
  async function fetchBin(url) {
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error(`Fetch failed: ${url}`);
    const buf = await res.arrayBuffer();
    return new Uint8Array(buf);
  }

  // 连接按钮
  const connectBtn = document.getElementById("btn-connect");
  // 写入按钮
  const flashBtn = document.getElementById("btn-flash");

  let loader;   // ESPLoader 实例（连上后复用）
  let port;     // SerialPort

  connectBtn.addEventListener("click", async () => {
    try {
      term.clean();
      term.writeLine("Requesting serial port...");
      // 选串口（如需过滤 VID/PID，可传 filters）
      port = await navigator.serial.requestPort({ /* filters: [] */});
      await port.open({ baudRate: 115200 }); // 初始 115200，后续由 stub 提升
      term.writeLine("Serial port opened.");

      // 创建传输与 Loader（注意：这里是“实例化后的 transport”传给 ESPLoader）
      const transport = new Transport(port);
      loader = new ESPLoader({ transport, baudrate: 921600, terminal: term });
      term.writeLine("Connecting to chip...");
      await loader.connect();   // 建立与 ROM bootloader 的连接
      term.writeLine("Connected. Detecting chip...");
      await loader.detectChip();
      term.writeLine(`Chip: ${loader.chip.CHIP_NAME || "ESP32"}`);
      term.writeLine("Ready to flash.");
    } catch (e) {
      term.writeLine("Connect error: " + e);
      try { if (port) await port.close(); } catch(_) {}
      loader = undefined;
    }
  });

  flashBtn.addEventListener("click", async () => {
    if (!loader) { term.writeLine("Not connected."); return; }
    try {
      term.writeLine("Fetching binaries...");
      const [boot, part, app] = await Promise.all([
        fetchBin(BIN_BOOT),
        fetchBin(BIN_PART),
        fetchBin(BIN_APP),
      ]);

      term.writeLine("Entering flashing stub...");
      await loader.runStub(); // 进入 stub，支持高速传输
      term.writeLine("Erasing (only necessary regions will be erased)...");
      // 组合镜像列表（地址升序）
      const images = [
        { data: boot, address: ADDR_BOOT },
        { data: part, address: ADDR_PART },
        { data: app,  address: ADDR_APP  },
      ];

      term.writeLine("Writing flash...");
      // writeFlash 会按顺序写入并自动计算校验
      await loader.writeFlash({
        fileArray: images,
        flashSize: "detect",
        eraseAll: false,
        compress: true,
      });

      term.writeLine("Verifying MD5...");
      for (const img of images) {
        const md5 = await loader.flashMd5sum(img.address, img.data.length);
        term.writeLine(`  0x${img.address.toString(16)}  MD5: ${md5}`);
      }

      term.writeLine("Flashing done. Resetting to run user code...");
      await loader.softReset();
      term.writeLine("✅ Done. You can close this tab now.");
      try { await port.close(); } catch(_) {}
    } catch (e) {
      term.writeLine("Flash error: " + e);
    }
  });

  // 环境自检
  (function checkEnv() {
    if (!("serial" in navigator)) {
      document.getElementById("log").textContent =
        "This browser does not support Web Serial. Please use Chrome/Edge (desktop).";
    }
  })();
</script>


